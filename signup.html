<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기존 스타일 유지 */
        :root {
            --font-gov: "대한민국 정부 상징 서체", "Malgun Gothic", "Apple SD Gothic Neo", sans-serif;
            --font-noto: "Noto Sans KR", sans-serif;
            --color-dark-gray: #8C8C8C;
            --color-gray: #D9D9D9;
            --color-light-gray: #F8F8F8;
            --color-green: #008573;
            --color-red: #E74C3C;
        }

        body {
            font-family: var(--font-noto);
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            font-family: var(--font-gov);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        hr {
            border: 0;
            height: 3px; 
            background-color: #333; 
            width: 100%;
            margin: 20px 0 40px 0;
        }

        .breadcrumb {
            font-size: 14px;
            color: var(--color-dark-gray);
            margin-bottom: 10px;
        }

        .breadcrumb a {
            text-decoration: none;
            color: var(--color-dark-gray);
        }

        .breadcrumb span {
            margin: 0 5px;
        }

        .main-container {
            background-color: var(--color-light-gray);
            padding: 40px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto;
        }

        .signup-form {
            display: grid;
            grid-template-columns: 120px 1fr; 
            gap: 15px 30px;
            align-items: start;
        }

        .signup-form label {
            font-size: 16px;
            color: #333;
            font-weight: 500;
            text-align: left;
            margin-top: 10px;
        }

        .required {
            color: var(--color-red);
            margin-right: 5px;
        }

        .signup-form input[type="text"],
        .signup-form input[type="password"],
        .signup-form input[type="email"],
        .signup-form input[type="number"],
        .signup-form input[type="tel"] { /* type="tel" 스타일 추가 */
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-gray);
            border-radius: 4px;
            background-color: #fff;
            box-sizing: border-box;
            font-family: var(--font-noto);
            font-size: 14px;
        }

        .validation-msg {
            font-size: 12px;
            margin-top: 5px;
            min-height: 18px;
        }
        .msg-error { color: var(--color-red); }
        .msg-success { color: var(--color-green); }

        .contact-inputs {
            display: flex;
            gap: 10px;
        }

        .contact-inputs input {
            flex: 1;
            text-align: center; /* 전화번호는 가운데 정렬이 이쁨 */
        }
        
        .mailing-service {
            display: flex;
            align-items: center;
            height: 40px; 
        }
        
        .mailing-service input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .mailing-service label {
            font-weight: 400;
            cursor: pointer;
            margin-top: 0;
        }

        .submit-button-container {
            grid-column: 2 / -1;
            text-align: right;
            margin-top: 20px;
        }

        .submit-button {
            width: auto;
            min-width: 100px; 
            padding: 10px 25px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            background-color: #009688; 
            display: block; 
            margin-left: auto; 
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            opacity: 0.95;
        }
        
        input[type=checkbox] {
            accent-color: var(--color-green);
        }

        /* Chrome, Safari, Edge, Opera 등에서 number input 화살표 제거 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>
    <main class="container">
        <nav class="breadcrumb">
            <a href="index.html">홈</a>
            <span> > </span>
            <span><a href="mypage.html">마이페이지</a></span>
            <span> > </span>
            <span class="current">회원가입</span>
        </nav>
        <h1>회원가입</h1>
        <hr>
        <div class="main-container">
            <form class="signup-form" id="signupForm">
                <label for="name"><span class="required">*</span>이름</label>
                <div>
                    <input type="text" id="name" required>
                </div>

                <label for="id"><span class="required">*</span>아이디</label>
                <div>
                    <input type="text" id="id" placeholder="5~20자 영문 소문자, 숫자, 특수기호(_),(-)" required>
                    <div id="idMsg" class="validation-msg"></div>
                </div>

                <label for="password"><span class="required">*</span>비밀번호</label>
                <div>
                    <input type="password" id="password" placeholder="8글자 이상" required>
                    <div id="pwMsg" class="validation-msg"></div>
                </div>

                <label for="password-confirm"><span class="required">*</span>비밀번호 확인</label>
                <div>
                    <input type="password" id="password-confirm" required>
                    <div id="pwConfirmMsg" class="validation-msg"></div>
                </div>

                <label><span class="required">*</span>연락처</label>
                <div>
                    <div class="contact-inputs">
                        <input type="tel" id="tel1" maxlength="3" placeholder="010" aria-label="연락처 앞자리" required>
                        <input type="tel" id="tel2" maxlength="4" aria-label="연락처 중간자리" required>
                        <input type="tel" id="tel3" maxlength="4" aria-label="연락처 뒷자리" required>
                    </div>
                    <div id="telMsg" class="validation-msg"></div>
                </div>

                <label for="email"><span class="required">*</span>이메일</label>
                <div>
                    <input type="email" id="email" required>
                </div>

                <label>메일링 서비스</label>
                <div class="mailing-service">
                    <input type="checkbox" id="mailing">
                    <label for="mailing">박물관 소식지 수신</label>
                </div>

                <div class="submit-button-container">
                    <button type="submit" class="submit-button">회원가입</button>
                </div>
            </form>
        </div>
    </main>

<script>
        const idInput = document.getElementById('id');
        const pwInput = document.getElementById('password');
        const pwConfirmInput = document.getElementById('password-confirm');
        
        const tel1 = document.getElementById('tel1');
        const tel2 = document.getElementById('tel2');
        const tel3 = document.getElementById('tel3');
        const telMsg = document.getElementById('telMsg');

        const idMsg = document.getElementById('idMsg');
        const pwMsg = document.getElementById('pwMsg');
        const pwConfirmMsg = document.getElementById('pwConfirmMsg');

        // 정규식
        const allowedCharRegex = /^[a-z0-9\-_]+$/;
        const startEndAlphanumericRegex = /^[a-z0-9].*[a-z0-9]$/;

        // [중요 1] 전역 변수에 유저 목록을 담아둡니다.
        let userDB = [];

        // [중요 2] 페이지 열리자마자 데이터 불러오기 (AJAX/Fetch + Web Storage)
        async function loadUserDB() {
            // 1. 로컬 스토리지 확인
            const localData = localStorage.getItem('userDB');
            
            if (localData) {
                userDB = JSON.parse(localData);
                console.log("로컬 스토리지 데이터 로드 완료:", userDB);
            } else {
                // 2. 없으면 JSON 파일에서 가져오기 (초기화)
                try {
                    const response = await fetch('./data.json');
                    userDB = await response.json();
                    // 가져온 김에 저장해두기
                    localStorage.setItem('userDB', JSON.stringify(userDB));
                    console.log("JSON 파일 데이터 로드 완료:", userDB);
                } catch (error) {
                    console.error("데이터 로드 실패:", error);
                    userDB = [];
                }
            }
        }
        
        // 함수 실행!
        loadUserDB();

        // 숫자만 입력받기
        function onlyNumbers(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        }

        // 1. 아이디 검사 함수 (중복 체크 추가됨!)
        function validateId() {
            const value = idInput.value;
            
            if (value.length === 0) {
                idMsg.textContent = "";
                return false;
            }

            // A. 길이 체크
            if (value.length < 5 || value.length > 20) {
                idMsg.textContent = "5~20자여야 합니다.";
                idMsg.className = "validation-msg msg-error";
                return false;
            }

            // B. 문자 체크
            if (!allowedCharRegex.test(value)) {
                idMsg.textContent = "영문 소문자, 숫자, 특수기호(_, -)만 가능합니다.";
                idMsg.className = "validation-msg msg-error";
                return false;
            }

            // C. 시작/끝 체크
            if (!startEndAlphanumericRegex.test(value) && value.length >= 2) {
                idMsg.textContent = "시작과 끝은 특수기호를 쓸 수 없습니다.";
                idMsg.className = "validation-msg msg-error";
                return false;
            }

            // [추가된 부분] D. 중복 아이디 체크
            // userDB 배열 안에 지금 입력한 value와 똑같은 id가 있는지 확인
            const isDuplicate = userDB.some(user => user.id === value);
            
            if (isDuplicate) {
                idMsg.textContent = "이미 사용 중인 아이디입니다."; // 안내 메세지
                idMsg.className = "validation-msg msg-error";    // 빨간색 스타일
                return false; // 유효하지 않음 처리
            }

            // 통과
            idMsg.textContent = "사용 가능한 아이디입니다.";
            idMsg.className = "validation-msg msg-success";
            return true;
        }

        // 2. 비밀번호 검사
        function validatePw() {
            const value = pwInput.value;
            if (pwConfirmInput.value.length > 0) validatePwConfirm();
            if (value.length === 0) { pwMsg.textContent = ""; return false; }
            if (value.length < 8) {
                pwMsg.textContent = "8글자 이상이어야 합니다.";
                pwMsg.className = "validation-msg msg-error";
                return false;
            }
            pwMsg.textContent = "사용 가능한 비밀번호입니다.";
            pwMsg.className = "validation-msg msg-success";
            return true;
        }

        // 3. 비밀번호 확인
        function validatePwConfirm() {
            const pwValue = pwInput.value;
            const confirmValue = pwConfirmInput.value;
            if (confirmValue.length === 0) { pwConfirmMsg.textContent = ""; return false; }
            if (pwValue !== confirmValue) {
                pwConfirmMsg.textContent = "비밀번호가 일치하지 않습니다.";
                pwConfirmMsg.className = "validation-msg msg-error";
                return false;
            } else {
                pwConfirmMsg.textContent = "비밀번호가 일치합니다.";
                pwConfirmMsg.className = "validation-msg msg-success";
                return true;
            }
        }

        // 4. 연락처 검사
        function validatePhone() {
            const t1 = tel1.value;
            const t2 = tel2.value;
            const t3 = tel3.value;

            if(!t1 || !t2 || !t3) {
                telMsg.textContent = "";
                return false;
            }
            const regExpHead = /^0([0-9]{1,2})$/;
            if (!regExpHead.test(t1)) {
                telMsg.textContent = "앞자리는 010, 02 등이어야 합니다.";
                telMsg.className = "validation-msg msg-error";
                return false;
            }
            if (t2.length < 3) {
                telMsg.textContent = "중간자리는 3자리 이상이어야 합니다.";
                telMsg.className = "validation-msg msg-error";
                return false;
            }
            if (t3.length < 4) {
                telMsg.textContent = "뒷자리는 4자리여야 합니다.";
                telMsg.className = "validation-msg msg-error";
                return false;
            }
            telMsg.textContent = "유효한 전화번호 형식입니다.";
            telMsg.className = "validation-msg msg-success";
            return true;
        }

        // 이벤트 리스너 등록
        idInput.addEventListener('input', validateId);
        pwInput.addEventListener('input', validatePw);
        pwConfirmInput.addEventListener('input', validatePwConfirm);
        [tel1, tel2, tel3].forEach(el => {
            el.addEventListener('input', (e) => {
                onlyNumbers(e);
                validatePhone();
            });
        });

        // 폼 제출 (회원가입 버튼 클릭)
        document.getElementById('signupForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // 최종 유효성 검사 (함수들이 true/false를 반환하므로 재사용)
            const isIdValid = validateId();
            const isPwValid = validatePw();
            const isPwConfirmValid = validatePwConfirm();
            const isPhoneValid = validatePhone();

            if (isIdValid && isPwValid && isPwConfirmValid && isPhoneValid) {
                // 데이터 저장 로직
                const newUser = {
                    name: document.getElementById('name').value,
                    id: idInput.value,
                    pw: pwInput.value,
                    phone: tel1.value + tel2.value + tel3.value,
                    email: document.getElementById('email').value
                };

                // userDB 배열에 추가하고 저장
                userDB.push(newUser);
                localStorage.setItem('userDB', JSON.stringify(userDB));

                alert("회원가입이 완료되었습니다! 로그인 페이지로 이동합니다.");
                location.href = 'login.html';
            } else {
                alert("입력 정보를 다시 확인해주세요.");
            }
        });
    </script>
</body>
</html>